# Designing Your Own Malware Sandbox 
## Security Rant
When analyzing or executing un-trusted code, it is wise to perform all work in an environment that is isolated from sensitive resources. In particular, it is strongly advised to conduct all research inside of a *sandbox*. A sandbox in the context of computer security is an environment that isolates resources from an executing program. 
When analyzing malware, you are strongly encouraged to use a sandbox that isolates malicious payloads from your file system, LAN, and the internet. This is to reduce the risk of accidentally infecting your computer or other devices.

An example sandbox that many of you have probably leveraged is found in Window's Antivirus engine. Windows by default will execute every un-trusted executable inside of a sandbox to dynamically detect malicious actions. If the executable was tested in the main environment, this could allow the code to tamper with system resources and defeats the purpose of anti-malware scanning. 

One strategy for creating a sandbox is to use Virtualization based isolation.  This involves using a *Hypervisor* to run a *Virtual Machine*.  A hypervisor is an emulator that allows you to run a *guest OS* inside of your *host OS*.  This class will directly support the use of the Virtualbox Hypervisor, but it is possible to use other including 
- HyperV 
- Vmware (If you have a license great! The vagrant script, however, is not setup to work for Vmware. You would need to make the changes yourself)
- QEMU (not recommended for Windows guest and is slow without hardware acceleration/virtualization )

For this class, there will be three virtual machines: a Windows sandbox, a Remnux gateway, and a Windows development environment. 

This Windows sandbox VM will serve as the primary environment to detonate* untrusted code and suspected malware. All execution of malicious code should be confined to this environment, and any deviation from this directive could result in damage to your host OS, and could lead to further infection. 

The Remnux VM will be the gateway for the sandbox VM. In particular, the Sandbox VM, after initial configuration, will not have direct network access. There will be a virtual network that routes all traffic from the Windows VM to the Remnux VM. This is to ensure that any code running on the sandbox is unable to tamper with analysis tools, and has a reduced risk of escaping to the open internet/LAN.


If you have enough space for three VMs,  it is advised to have two separate windows VMs. One for analysis of malware, and one for development of code. If you are unable to  run 3 VMs or do not have enough space, you *can* do all of your development on the Windows sandbox VM, but  this adds unnecessary risk. 

# Disclaimers: 
## Virtualization is not always enough
**Virtualization based isolation is not a fool proof solution**. Exploits for hypervisors exist, and if the malware is packaged with such an exploit they can escape the sandbox.   In particular, it is possible that the malware can detect that it is in a virtual environment, and  can escape either via a misconfiguration or exploitation. From there,  it can spread to the host OS.  This is rare in practice but not impossible.  This is  why when analyzing malware from a sophisticated actor, it is essential to do a clean install for each sample, and ensure the host and guest OS are NOT connected to the internet or any critical network via any communication channel (USB, bluetooth, ...etc)

When analyzing crimeware, the setup used in this class should provide adequate guest isolation and is *probably* safe. That said, the course authors make no guarantees about the safety of the sandbox outside of the context of the class.  Failure to configure the sandbox correctly could result in the corruption of host resources.  Please read the following directions very carefully. If you find yourself analyzing sophisticated malware, please consult your organizations best practices.  

## Our sandbox is obviously a sandbox
The sandbox for this class takes no steps to hide its identity as a sandbox. It is obviously running VirtualBox, and has a suite of common analysis tools in the default location. For real world detonation at scale, it is necessary to take steps to configure the Windows VM to look more like a legitimate device. This will be explored towards the end of the course time permitting.  As a punchline though, in order yo build a more stealthy sandbox, it is essential to have access to the source code of the hypervisor. For this case, Hyperdbg/KVM are good choices.

# Before you begin:
- Download VirtualBox https://www.virtualbox.org/
- Read through https://www.oracle.com/technical-resources/articles/it-infrastructure/admin-manage-vbox-cli.html
- If you want to automate the deployment, download Vagrant https://www.vagrantup.com/downloads  
	- That said, I would recommend going through this process manually *at least once*. It is good practice.
	- Note, don't forget to add vagrant to your path
- Make sure you have git installed on your host os Host OS
- Clone the course repo

# Directions
For each section, follow the directions and leverage files contained inside of `../LabSetup`

# Virtualbox network 
Before installing any virtual machines, if you aren't using Virtualbox, you should setup a virtual network. If you are using VirtualBox, this step is handled later. 

# Remnux 
In this section, you will install and configure Remnux.
To do this, you need to 
1) install/import a Remnux (ubuntu base) VM
2) Configure  a network adapter on a private virtual network
3) Setup the default behavior or Inetsim
4) Setup Burpsuite or MITMproxy 
5) Allow network connections from your Windows sandbox, thus, positioning the Remnux VM as a gateway. 

- If your host OS is Mac OS or Linux, feel free to download the Virtualbox  OVA file https://docs.remnux.org/install-distro/get-virtual-appliance and follow the directions to import the appliance into Virtualbox  manually. 
	- Alternatively, you can run ``` VBoxManage import --dry-run remnux-v7-focal.ova``` and then based on those options import import the appliance. See https://docs.oracle.com/en/virtualization/virtualbox/6.0/user/vboxmanage-import.html for more.  I ended up running `VBoxManage import remnux-v7-focal.ova  --vsys 0  --ostype "Ubuntu_64" -vmname "Remnux"`
- If your Host OS is Windows, you can still import the Remnux OVA  into Virtualbox, but you will have to disable Hyper-V on your host OS. I personally don't like doing this because it prevents you from using WSL and disables virtualization based security/isolation on your host os. I.e., lsass  no longer gets virtualization based security.
- If you want to keep Hyper-V enabled, you have two options: manual install, or containerized installation. 
- For container insulation, please see https://docs.remnux.org/run-tools-in-containers/remnux-containers
- For manual instalation, please follow the directions here to setup Remnux from scratch. You will need an Ubuntu ISO.
	- https://docs.remnux.org/install-distro/install-from-scratch
	- You are also allowed to use a lighter VM such as a fresh Debian/Ubuntu instance, **but** you will be responsible for installing the required tools. 
	- For this assignment, you will need Inetsim, Wireshark, iptables, Burpsuite, Ghidra. 
- After importing your VM into Virtualbox, click settings, and go to Network. Click on adapter 2 and enable. Then set "Attached to" -> Internal Network  
Choose a name (I chose PrivateNetwork because I am creative) and click save.
- For the Vagrant, I chose `ch0nky`  
- Alternatively, use the CLI to add a network `VBoxManage modifyvm "Remnux" --nic2 intnet --intnet2 "ch0nky"`
	- here we modify the vm named Remnux to modify its second Network adapter to be internal and named ch0nky. For more on how internal networks work, see https://www.nakivo.com/blog/virtualbox-network-setting-guide/
- Once installed, boot up your vm. You can do this from a shell with `VBoxManage startvm  "Remnux" ` or use the GUI and click the green start button. Now login. (the password is malware for the OVF, whatever you set it as for ubuntu, and vagrant/vagrant if you automated the process)

Our plan is to position Remnux as the default gateway for our windows instance, and force all traffic through it. We can then choose whether or not to relay traffic to the open internet afterwards.
![[network.png]]

To accomplish this, we have two action items:
- 1) Modify the configuration for your new adapter
- 2) Modify the configuration for a tool called `inetsim`

For those who are not familiar with networking in Linux, please see this introduction: https://www.youtube.com/watch?v=Yr6qI6v1QCY (mostly the last section where he talks about netplan config)


open up a terminal and run 
```
sudo -i
```
to drop into a root shell . 

First, verify that this machine is internet connected. I like to use `ping 1.1.1.1` to verify connectivity but depending on your network, pings might be blocked.  Opening a browser and visiting `example.com` or any website should be sufficient.  If you are unable to connect to the internet, start by diagnosing the following: 
1) DNS: (`nslookup google.com` Does it work?)
2) Routing: ( 
```bash
nc example.com 80
GET / HTTP/1.0
```
3) DHCP Lease: `renew-dhcp`

Now that you have verified internet connection: upgrade your machine
`remnux update && remnux upgrade`
If the upgrade fails, check the saltstack log. Odds are you need to update the system first (`sudo apt-get update && sudo apt-get upgrade`)


Verify that the there are 3  network interface (most likely the 3rd one corresponds to the internal network). On my machine, when setup manually, it is named `enp0s8` and when imported from the ova it is called `enp0s17`.  If you use Vagrant, it should be `eth1`. To verify which one actually corresponds to the internal network, disconnect the network adapter using the GUI or VBoxManage, and see if you can still connect to the internet. If you can, then you disabled the internal adapter.  You can view all network interfaces by running `ip a`
If not, look for the name of the 3rd interface and replace its  `enp0s8` with its name.  
![[net_interface.png]]


From there, run the following to create a configuration file that sets your static IP on this interface
**Be sure to replace `enp0s8` with the name of your interface that corresponds to the private network!**
```bash
# this creates a new yaml file 
cat >> /etc/netplan/malware-lab.yaml << EOL
network:
        version: 2
        renderer: networkd
        ethernets: 
                enp0s8: 
                        dhcp4: no
                        addresses: 
                                - 10.10.10.2/24
EOL
sudo netplan apply
```

Again: make sure to replace  `enp0s8` with whatever your new interface is called.

Finally, run `accept-all-ips start enp0s8` to allow traffic to the specified interface.  
- *Bonus*: look at how accept-all-ips works. Can you figure out how to perform the same action, except only allow traffic from `10.10.10.3` (the static IP of the Windows  malware sandbox)?

The configuration above is used to set a static IP address for our machine on the internal network.

## Configure Inetsim
Inetsim, as the name suggests, is a collection of tools to  run simulated network services  suspicious binaries to interact with.
- Make a copy of the inetsim configuration
- `cp /etc/inetsim/inetsim.conf ~/Desktop/my_inetsim.conf`
	- You can name it whatever you want, and place it anywhere you want. 
	Start up your favorite text editor and modify the following:
	
- enable the DNS server by un-commenting `start_service dns` and `start_service dummy_tcp`
	- eg![[inetsim_service_dns.png]]
- In service bind address,  set `service_bind_address    10.10.10.2`
	-  eg ![[inetsim_bind_addr.png]]
- In dns_default_ip set `dns_default_ip          10.10.10.2`
- To modify the port that dummy_tcp runs on, set `dummy_bind_port	1234` in the `# Service Dummy` section
- Finally, to run with our new configuration, run  `sudo inetsim --config=/path/to//my_inetsim.conf` 

If everything works, you should be able to  interact with the Inetsim services from both your Remnux VM and your Windows sandbox VM (once it is setup). To make sure it is working, run `curl http://10.10.10.2:80` and note the response body.  Also run `sudo ss -tulnp` to view information about processes binding on specific ports.  

# Optional: remnux + VBox Guest Additions 
If you used the general OVA or installed from scratch, you will need to install guest additions.  If you imported directly, there is nothing to be done this step. 

Go to Devices-> insert guest additions. Then run the install scripts from the removable disk. Reboot remnux. 
# Windows Sandbox  Setup
Grab yourself a 90 day trial VM from Microsoft. 
## Enterprise with admin
https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise
## Home
https://www.microsoft.com/en-us/software-download/windows10ISO

You can also use a pre-configured one 
- `https://github.com/gusztavvargadr/packer` 
- https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise
	- Fill in fake information. No need to get spammed by Microsoft
	- From there, add the ISO to a new Windows VM and follow the directions to get set up. 
	- This should drop you into an Administrator account. From there, you should run the install scripts .
	

This section con be completed as either a single VM (don't do this please :-) ) or as two separate VMs.  By the end of this section, you should have a Development VM, and a sandbox VM.  First, we will setup the Windows Sandbox VM.


Add the downloaded ISO to the empty disk slot
![[vm_storage_empty.png]]
![[vm_storage_set.png]]

Afterwards, consider adding more CPU resources and video  memory (at least 128MB). Finally, click start. 
- On the boot screen, follow the directions to install. You don't need an office account. If it asks for one, click join domain.
- For Home edition, make sure to disconnect the network adapter to ensure there is no internet access.  This will allow you to install windows 10 without creating an account.
-  Skip the upgrade for now and click custom install 
-  This will take a bit.
- Once completed, re-enable the network adapter (nic1)
-  Just as in Remux, add a new private network interface with the same Network name as chosen previously. I.e., all VMs with an adapter on internal network <blah> will be able to see other VMs with an adapter for <blah>
- Next, install Virtualbox Guest additions. Please follow the directions here https://docs.oracle.com/cd/E36500_01/E36502/html/qs-guest-additions.html 
- Now create a shared folder on your Host VM (I called mine `sharevm`)
- Go to shared folders and click the folder with a green plus to`sharevm`  as a shared folder. Copy the install scripts in ../lab_setup/Windows* into the shared folder
	- ALternatively, use VBoxManage `VBoxManage sharedfolder add "WindowsBox" --name sharevm -hostpath /home/user/sharevm -readonly -automount` with the command modified based on your system. see https://docs.oracle.com/en/virtualization/virtualbox/6.0/user/vboxmanage-sharedfolder.html for more.
From there, copy the install scripts over to your new Windows VM. Run them in the following order: 
- First, Make sure you have internet `ping 1.1.1.1`
- Second, install Boxstarter by running from an elevated shell  `box.ps1` 
	- to get an elevated shell, right click powershell.exe and run as admin
- Then from a Boxstarter shell, run the following scripts in order:
	-  `tools.ps1`  to install all of the necessary tools for the sandbox
	
	The setup scripts should have created a new local admin account named Ronald Fillabuster (A great fake name) with a very secure password `P@ssw0rd!`
- Switch to this new local admin account.
	-  Run `network.ps1` to fix a static IP for the Sandbox VM, and to position Remnux as the default gateway and default DNS. 
		-  If you are unsure how to run a powershell script from a command prompt, see https://lmgtfy.app/?q=how+to+run+a+powershell+script+from+command+line :-)
	    -  If you get an error about the execution policy...Google it :D 
	-  Feel free to customize tools.ps1. I would also advise you to read the contents of the script! 
- Optionally, update your windows VM.
	
 Now that all of the tools needed for the course are installed, it is important to disconnect the sandbox from the internet. To do this, disable  the first network adapter. On my device,  this entails disabling the NAT interface on the sandbox VM by clicking the bottom right network icon,  and unchecking the first entry. If you need more tools or need to update, enable the first interface again. Once this is done, **TAKE A SNAPSHOT**
	 VMs are notoriously unstable. **TAKE A SNAPSHOT**.  If you do not **TAKE A SNAPSHOT** and you're VM stops working, you might have to repeat all of the previous steps. So  please, **TAKE A SNAPSHOT**. Did I mention that you should **TAKE A SNAPSHOT**? 
	
![[snapshot.png]]
		
- ![[Network_addapters.png]]



- Test your connection by trying to ping remnux `ping 10.10.10.2`
- Make sure you can't reach google: `ping 8.8.8.8` and more generally make sure you VM is cut off from the internet. 
	- If you try pinging  an external IP and the response time is `<1ms`, this probably not a problem (think about why :-) ) 


## Windows Development
Repeat the same steps above, but **omit** the following steps: 
- Second network adapter
- `network.ps1`

Once all of the tools are installed, create a shared folder to perform development on the host OS and share it with the guest. 
Once setup, **TAKE A SNAPSHOT** 

# Setup Flag
- Now that your vms are setup, create a shared folder on your Remnux box, and host a simple python server with `python3 -m http.server --bind 10.10.10.2 --directory /tmp/jail/ 1337
` to host a static file server on port 1337. To download files, simply visit `http://remnux:1337/` and download files there. Note this server will server will serve files from whatever directory you run the 
- If you do directly mount the folder on your guest Windows vm, make sure that it is read only! Think about what happens if the malware you detonate is ransomware 
- To add a shared folder, select your VM and click settings
- Go to shared folders and add one
- ![[shared_folder.png]]
- Now copy `hw0.exe` over to your windows machine.  Do not ever enable drag and drop on your Windows sandbox.
- You should have inetsim running on your Remnux instance configured as described above.
- Open a terminal and run `sudo wireshark`
	- Select the network interface associated with your private network  (`enp0s8/eth1...etc`)
- now on the windows machine, run `hw0.exe`  and wait for execution to terminate. 
- Once the program exits, stop wireshark capture by clicking the shark fin icon in the top left corner.
![[wireshark1.png]]
- Scroll down on the TCP traffic and look for packets that contain the pattern `FLAG{`
![[flag.png]]
- Once found, right click the packet and select `follow-->follow tcp stream`
![[follow_tcp.png]]
- Inside of this window, there should be a flag! submit this to the CTF.
![[flag2.png]]
- For those of you with some reverse engineering experience, you probably shouldn't waist  your time trying to  reverse the binary since it is protected with military grade encryption.  


# Vagrant Setup
- If you opt to use Vagrant to setup your environment, open a terminal in the  Remnux directory. 
Run `vagrant up  --provision`

- Once it finishes, you should have a remnux VM. You should expect installation to take 1-2 hours depending on your network connection. 
- To monitor progress, open up Virtualbox and select `show` on the new VM
- Once installed, you can run `vagrant up` 

# Windows
- Run `vagrant up`
- This will take a bit to download and setup the windows VM. You will probably see an error on the Virtualbox GUI. Click ignore, and restart once it finishes. 
- Try running `vagrant up` followed by `vagrant ssh`
- If everything works, run `vagrant up --provision`
- Warning: I read through the packer script used to create the 3rd party windows Vagrant box, but I make no guarantees that it isn't backdoored in some way.   Use at your own risk. :-)
There is also a bug with the Remnux box that is installed from scratch on some Host OSes that makes it take forever to boot up. I have not figured out what causes this but if you run into trouble, just import the virtual appliance. 
	
	
	For a more involved setup using KVM, see
	https://c3rb3ru5d3d53c.github.io/documents/kvm-malware-lab/
	
	
